"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.githubGetDiffMap = void 0;
var UNKNOWN_FILE = "Unknown";
function githubGetDiffMap(rawDiff) {
    var _a;
    console.info('Gathering diffs...');
    var diffMap = new Map();
    var path = UNKNOWN_FILE;
    for (var _i = 0, _b = rawDiff.split('\n'); _i < _b.length; _i++) {
        var line = _b[_i];
        if (line.startsWith('diff --git')) {
            // TODO: Handle spaces in path
            // TODO: Will this continue to work with other GitHub integrations?
            // path = `${process.env.GITHUB_WORKSPACE}/${line.split(' ')[2].substring(2)}`
            path = "".concat(line.split(' ')[2].substring(2));
            if (path === undefined) {
                path = UNKNOWN_FILE;
            }
            diffMap.set(path, []);
        }
        if (line.startsWith('@@')) {
            var changedLines = line.substring(3);
            changedLines = changedLines.substring(0, changedLines.indexOf(' @@'));
            var linesAddedPosition = changedLines.indexOf('+');
            if (linesAddedPosition > -1) {
                // We only care about the right side because Coverity can only analyze what's there, not what used to be --rotte FEB 2022
                var linesAddedString = changedLines.substring(linesAddedPosition + 1);
                var separatorPosition = linesAddedString.indexOf(',');
                var startLine = parseInt(linesAddedString.substring(0, separatorPosition));
                var lineCount = parseInt(linesAddedString.substring(separatorPosition + 1));
                var endLine = startLine + lineCount - 1;
                if (!diffMap.has(path)) {
                    diffMap.set(path, []);
                }
                console.info("Added ".concat(path, ": ").concat(startLine, " to ").concat(endLine));
                (_a = diffMap.get(path)) === null || _a === void 0 ? void 0 : _a.push({ firstLine: startLine, lastLine: endLine });
            }
        }
    }
    return diffMap;
}
exports.githubGetDiffMap = githubGetDiffMap;
